<!DOCTYPE html>
<html>
	<head>
		<title>Ping Test</title>
	</head>
	<body>

	<script>
(() => {

	const wsBase = () => {
		const l = window.location;
		return `${l.protocol.replace('https:', 'wss:').replace('http:', 'ws:')}//${l.host}${l.pathname.match('.*/')[0]}`;
	};

	const sendAndWait = (ws, data, timeoutMs) => new Promise((resolve, reject) => {
		let timeoutId = setTimeout(() => {
			ws.onmessage = undefined;
			resolve({ timedOut: true, timeoutMs });
		}, timeoutMs);
		let sendTimeMs = performance.now();
		ws.send(data);
		ws.onmessage = async (event) => {
			let recvTimeMs = performance.now();
			clearTimeout(timeoutId);
			let rttMs = recvTimeMs - sendTimeMs;
			ws.onmessage = undefined;
			resolve({ timedOut: false, event, rttMs });
		};
	});

	const sleep = durationMs => new Promise(resolve => setTimeout(resolve, durationMs));

	const genRandomBytes = n => crypto.getRandomValues(new Uint8Array(n));

	const ws = new WebSocket(`${wsBase()}ws`);
	ws.onopen = async () => {
		let payload = genRandomBytes(128);
		for (let i = 0; i != 100; ++i) {
			const result = await sendAndWait(ws, payload, 2000);
			if (result.timedOut) {
				console.log(`${i} timed out`);
			} else {
				console.log(`${i} rtt ${result.rttMs} ms`);
			}
			await sleep(100);
		}
	};

})();
	</script>
	</body>
</html>
